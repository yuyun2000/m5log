## 语种特征排列不对
![](../../file/Pasted%20image%2020250826101103.png)
排列从第一种修改成第二种，指标从 整体词错误率 (WER): 0.3079 (30.79%) 降低到 整体词错误率 (WER): 0.3062 (30.62%)
显然这不是主要原因


## mask生成不对
生成的mask始终是 1 1 68 的全1序列，正常来说最后一次推理如果长度不满的话，被pad的部分mask应该是0
修复后wer降低至 0.3056 (30.56%)
这也不是主要问题


## 使用全0pad
这里使用全0pad+mask理论上应该没有问题了，但是实际上推理出来的文本末尾依然很奇怪，比如
![](../../file/Pasted%20image%2020250826103533.png)
很明显的末尾都有异常，但是更换为静音pad后没有改善，这个先挂起


# 切片过短，语义受损
现在是64帧推理一次，对应的音频时长是3.8秒左右，这是现在推理流程的耗时分析：
```
预处理耗时: 0.2019s
计算分片参数耗时: 0.0001s

--- 处理第 1/3 个分片 ---
  特征处理耗时: 0.0004s
  模型推理耗时: 0.0185s
  CTC后处理耗时: 0.0030s
  前缀处理耗时: 0.0000s
  Token转文本耗时: 0.0002s
  分片总耗时: 0.0224s

--- 处理第 2/3 个分片 ---
  特征处理耗时: 0.0003s
  模型推理耗时: 0.0187s
  CTC后处理耗时: 0.0031s
  前缀处理耗时: 0.0007s
  Token转文本耗时: 0.0002s
  分片总耗时: 0.0233s

--- 处理第 3/3 个分片 ---
  特征处理耗时: 0.0005s
  模型推理耗时: 0.0165s
  CTC后处理耗时: 0.0017s
  前缀处理耗时: 0.0006s
  Token转文本耗时: 0.0001s
  分片总耗时: 0.0197s

=== 推理耗时总结 ===
预处理耗时: 0.2019s (75.4%)
分片处理总耗时: 0.0654s (24.4%)
  - 模型推理总耗时: 0.0536s (20.0%)
  - CTC后处理总耗时: 0.0078s (2.9%)
  - 前缀处理总耗时: 0.0014s (0.5%)
总耗时: 0.2677s
处理了 3 个分片
平均每个分片耗时: 0.0218s
```
可以看到预处理的耗时都远大于推理耗时，所以如果通过提高分片长度提升wer，这个是可以的


## 反向验证：将原生推理流程调成onnx固定分段式
此时原生的pt模型推理也出现了类似的问题：
![](../../file/Pasted%20image%2020250826142500.png)
末尾也有奇怪的东西，并且指标跌至0.3214 (32.14%)
下面是不同推理片段下词错误率的指标

| 片段长度 | 对应时长  | WER    | 端侧单次推理耗时  |
| ---- | ----- | ------ | --------- |
| 64   | 3.82s | 32.14% | 0.022s    |
| 128  | 7.64s | 16.58% | 0.04s（预估） |
| 160  | 9.55s | 15.05% | 0.05s（预估） |
| 320  | 19.1s | 14.83% | ...       |

注：
1、该模型是非自回归模型，不能像whisper那样进行无损的自回归输出，就像yolo那样一张图分片检测多少都有损失
2、预估的时间是线性叠加的
3、真实的WER肯定和真实场景下的音频长度范围有关系，如果大部分音频都是3s，那么片段64的WER应该也不会很低
4、并且过长的pad不会对短音频的识别造成负面影响，如最后一列固定识别19s的音频，指标也是更偏向原生推理指标


